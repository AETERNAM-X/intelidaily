<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>InteliDaily - Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}" type="image/x-icon">
    <script>
      window.MathJax = {
        tex: {
          inlineMath: [['$', '$'], ['\\(', '\\)']],
          displayMath: [['$$', '$$'], ['\\[', '\\]']],
          processEscapes: true,
          processEnvironments: true
        },
        options: {
          skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
          ignoreHtmlClass: 'tex2jax_ignore',
          processHtmlClass: 'tex2jax_process'
        }
      };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <style>
        :root {
            --inteli-primary: #3B82F6;
            --inteli-secondary: #1E40AF;
            --inteli-accent: #F59E0B;
            --inteli-light: #F8FAFC;
            --inteli-dark: #0F172A;
            --inteli-text: #F1F5F9;
            --inteli-muted: #94A3B8;
            --inteli-border: #334155;
            --inteli-success: #10B981;
            --inteli-warning: #F59E0B;
            --inteli-danger: #EF4444;
            --inteli-bg: #0F172A;
            --inteli-card: #1E293B;
        }

        * {
            font-family: 'Inter', sans-serif;
        }

        body {
            color: var(--inteli-text);
            background: var(--inteli-bg);
            min-height: 100vh;
        }

        .hero-section {
            background: var(--inteli-card);
            color: var(--inteli-text);
            padding: 1.5rem 0;
            border-bottom: 1px solid var(--inteli-border);
        }

        .stat-card {
            background: var(--inteli-card);
            border: 1px solid var(--inteli-border);
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .exam-card {
            background: var(--inteli-card);
            border: 1px solid var(--inteli-border);
            border-radius: 8px;
            cursor: pointer;
        }

        .exam-card:hover {
            border-color: var(--inteli-primary);
        }

        .exam-card.selected {
            border-color: var(--inteli-primary);
            background: var(--inteli-card);
        }

        .btn-primary {
            background: var(--inteli-primary);
            border: 1px solid var(--inteli-primary);
            border-radius: 6px;
            padding: 12px 30px;
            font-weight: 600;
        }

        .btn-primary:hover {
            background: var(--inteli-secondary);
            border-color: var(--inteli-secondary);
        }

        .btn-outline-primary {
            color: var(--inteli-primary);
            border-color: var(--inteli-primary);
            border-radius: 6px;
        }

        .btn-outline-primary:hover {
            background: var(--inteli-primary);
            border-color: var(--inteli-primary);
            color: white;
        }

        .btn-outline-success {
            color: var(--inteli-success);
            border-color: var(--inteli-success);
        }

        .btn-outline-success:hover {
            background: var(--inteli-success);
            border-color: var(--inteli-success);
            color: white;
        }

        .btn-outline-info {
            color: var(--inteli-primary);
            border-color: var(--inteli-primary);
        }

        .btn-outline-info:hover {
            background: var(--inteli-primary);
            border-color: var(--inteli-primary);
            color: white;
        }

        .btn-outline-secondary {
            color: var(--inteli-muted);
            border-color: var(--inteli-border);
        }

        .btn-outline-secondary:hover {
            background: var(--inteli-border);
            border-color: var(--inteli-border);
            color: var(--inteli-text);
        }

        /* Corrigir animações dos botões */
        .btn {
            transition: all 0.2s ease;
        }

        .btn:hover {
            transform: none;
        }

        .btn:focus {
            box-shadow: 0 0 0 0.2rem rgba(59, 130, 246, 0.25);
        }

        .btn-outline-primary:focus {
            box-shadow: 0 0 0 0.2rem rgba(59, 130, 246, 0.25);
        }

        .btn-outline-success:focus {
            box-shadow: 0 0 0 0.2rem rgba(16, 185, 129, 0.25);
        }

        .btn-outline-info:focus {
            box-shadow: 0 0 0 0.2rem rgba(59, 130, 246, 0.25);
        }

        .btn-outline-secondary:focus {
            box-shadow: 0 0 0 0.2rem rgba(148, 163, 184, 0.25);
        }

        /* Link do GitHub */
        footer a {
            transition: all 0.2s ease;
        }

        footer a:hover {
            color: var(--inteli-primary) !important;
            text-decoration: underline !important;
            opacity: 0.8;
        }

        .history-item {
            background: var(--inteli-card);
            border: 1px solid var(--inteli-border);
            border-radius: 6px;
            padding: 0.75rem;
            margin-bottom: 0.75rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .progress {
            background-color: var(--inteli-border);
            border-radius: 4px;
        }
        
        .progress-bar {
            border-radius: 4px;
        }

        .progress-circle {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.2rem;
            background: var(--inteli-card);
            border: 1px solid var(--inteli-border);
        }

        .section-title {
            color: var(--inteli-primary);
            font-weight: 600;
        }

        .badge.bg-primary {
            background-color: var(--inteli-primary) !important;
        }

        .text-primary {
            color: var(--inteli-primary) !important;
        }

        .text-muted {
            color: var(--inteli-muted) !important;
        }

        .text-dark {
            color: var(--inteli-text) !important;
        }

        .text-black {
            color: var(--inteli-text) !important;
        }

        .bg-light {
            background-color: var(--inteli-card) !important;
            color: var(--inteli-text) !important;
        }

        .bg-white {
            background-color: var(--inteli-card) !important;
            color: var(--inteli-text) !important;
        }

        .alert-info {
            background-color: var(--inteli-card);
            border-color: var(--inteli-primary);
            color: var(--inteli-text);
        }

        .modal-header {
            background: var(--inteli-card);
            color: var(--inteli-text);
            border-bottom: 1px solid var(--inteli-border);
        }

        .modal-content {
            background: var(--inteli-card);
            border: 1px solid var(--inteli-border);
        }

        .modal-header .btn-close {
            filter: invert(1);
        }

        .form-check-input:checked {
            background-color: var(--inteli-primary);
            border-color: var(--inteli-primary);
        }

        .form-check-input {
            width: 1.2rem;
            height: 1.2rem;
            margin-top: 0.1rem;
        }

        .form-check-label {
            cursor: pointer;
            padding-left: 0.5rem;
        }

        .exam-card {
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .exam-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .exam-card.selected {
            border-color: var(--inteli-primary);
            background-color: rgba(59, 130, 246, 0.1);
        }

        /* Cards simples */
        .card {
            background: var(--inteli-card);
            border: 1px solid var(--inteli-border);
            border-radius: 8px;
        }

        .card-body {
            color: var(--inteli-text);
        }

        /* Texto branco para melhor contraste */
        .text-white {
            color: white !important;
        }

        /* Controle de tamanho do gráfico */
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
            overflow: hidden;
        }

        .chart-container canvas {
            max-height: 300px !important;
            height: 300px !important;
            width: 100% !important;
        }

        /* Result images (responsive like in simulado) */
        .image-gallery { display: grid; grid-template-columns: 1fr; gap: 8px; }
        .question-image { max-width: 100%; height: auto; object-fit: contain; border: 1px solid var(--inteli-border); border-radius: 6px; }
        @media (min-width: 640px) {
          .image-gallery { grid-template-columns: repeat(2, minmax(0, 1fr)); }
        }
        @media (min-width: 1024px) {
          .image-gallery { grid-template-columns: repeat(3, minmax(0, 1fr)); }
        }

        /* Responsividade para dispositivos móveis */
        @media (max-width: 768px) {
            .hero-section {
                padding: 1.5rem 0;
                background: var(--inteli-card);
            }
            
            .hero-section .display-4 {
                font-size: 2rem;
            }
            
            .hero-section .lead {
                font-size: 1rem;
            }
            
            .exam-card {
                margin-bottom: 1rem;
                background: var(--inteli-card);
            }
            
            .history-item {
                padding: 1rem;
                background: var(--inteli-card);
            }
            
            .history-item .row {
                flex-direction: column;
            }
            
            .history-item .col-md-5,
            .history-item .col-md-4,
            .history-item .col-md-3 {
                width: 100%;
                margin-bottom: 1rem;
            }
            
            .history-item .text-end {
                text-align: center !important;
            }
            
            .modal-dialog {
                margin: 0.5rem;
            }
            
            .modal-lg {
                max-width: calc(100% - 1rem);
            }
            
            .chart-container {
                height: 250px;
            }
            
            .chart-container canvas {
                height: 250px !important;
            }
        }

        @media (max-width: 480px) {
            .hero-section {
                padding: 1rem 0;
                background: var(--inteli-card);
            }
            
            .hero-section .display-4 {
                font-size: 1.75rem;
            }
            
            .hero-section .lead {
                font-size: 0.9rem;
            }
            
            .exam-card {
                padding: 1rem;
                background: var(--inteli-card);
            }
            
            .history-item {
                padding: 0.75rem;
                background: var(--inteli-card);
            }
            
            .btn {
                padding: 0.5rem 1rem;
                font-size: 0.875rem;
            }
            
            .btn-sm {
                padding: 0.375rem 0.75rem;
                font-size: 0.75rem;
            }
            
            .chart-container {
                height: 200px;
            }
            
            .chart-container canvas {
                height: 200px !important;
            }
        }
    </style>
</head>
<body>
    <!-- Hero Section -->
    <section class="hero-section">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-lg-8">
                    <h1 class="display-4 fw-bold mb-3">
                        <i class="fas fa-graduation-cap me-3"></i>
                        InteliDaily
                    </h1>
                    <p class="lead mb-4">Prepare-se para o processo seletivo da Inteli com simulados personalizados de provas anteriores.</p>
                    <p class="text-light mb-4" style="font-style: italic; font-size: 0.9rem;">
                        <i class="fas fa-quote-left me-2"></i>
                        Para alguns, bom o suficiente sempre será bom o suficiente, mas talvez não para você. Seja bem-vindo.
                        <i class="fas fa-quote-right ms-2"></i>
                    </p>
                </div>
                <div class="col-lg-4 text-center">
                    <i class="fas fa-graduation-cap" style="font-size: 8rem; opacity: 0.3; color: var(--inteli-primary);"></i>
                </div>
            </div>
        </div>
    </section>



    <!-- Available Exams Section -->
    <section class="py-4" style="background: var(--inteli-bg);">
        <div class="container">
            <h2 class="text-center mb-5 section-title" style="margin-top: 2rem;">
                <i class="fas fa-file-alt me-2"></i>Provas Disponíveis
            </h2>
            <div class="row" id="examsContainer">
                <!-- Exams will be loaded here -->
            </div>
        </div>
    </section>

    <!-- Recent Simulados Section -->
    <section class="py-4" style="background: var(--inteli-bg);">
        <div class="container">
            <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-2">
                <h2 class="section-title mb-0 mx-auto">
                    <i class="fas fa-history me-2"></i>Simulados Recentes
                </h2>
                <div class="text-end w-100 w-md-auto text-center text-md-end">
                    <span class="me-2">Folhas de gabarito:</span>
                    <a class="btn btn-sm btn-outline-secondary me-1" href="/simulados/Gabarito-Final-Prova-PS-2025.1.pdf" target="_blank">2025</a>
                    <a class="btn btn-sm btn-outline-secondary me-1" href="/simulados/Processo-Seletivo-2024.1.pdf" target="_blank">2024</a>
                    <a class="btn btn-sm btn-outline-secondary" href="/simulados/Provas-Inteli.pdf" target="_blank">2023/2022</a>
                </div>
            </div>
            <div class="row" id="historyContainer">
                <!-- History will be loaded here -->
            </div>
        </div>
    </section>

    <!-- Create Simulado Modal -->
    <div class="modal fade" id="createSimuladoModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-plus me-2"></i>Criar Novo Simulado
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-4">
                        <h6>1. Selecione as provas:</h6>
                        <div id="examSelectionContainer" class="row">
                            <!-- Exam selection will be loaded here -->
                        </div>
                    </div>
                    <div class="mb-4">
                        <h6>2. Configuração do simulado:</h6>
                        
                        <!-- Seletor de modo -->
                        <div class="mb-3">
                            <label class="form-label">Modo de seleção:</label>
                            <div class="btn-group w-100" role="group">
                                <input type="radio" class="btn-check" name="simuladoMode" id="modeRandom" value="random" checked>
                                <label class="btn btn-outline-primary" for="modeRandom">
                                    Aleatório
                                </label>
                                
                                <input type="radio" class="btn-check" name="simuladoMode" id="modeCustom" value="custom">
                                <label class="btn btn-outline-primary" for="modeCustom">
                                    Personalizado
                                </label>
                            </div>
                        </div>
                        
                        <!-- Configuração aleatória -->
                        <div id="randomConfig" class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>24 questões distribuídas em 4 blocos:</strong><br>
                            • Bloco 1: 8 questões<br>
                            • Bloco 2: 6 questões<br>
                            • Bloco 3: 6 questões<br>
                            • Bloco 4: 4 questões<br>
                            <small class="text-muted">As questões serão selecionadas aleatoriamente das provas escolhidas.</small>
                        </div>
                        
                        <!-- Configuração personalizada -->
                        <div id="customConfig" class="alert alert-warning" style="display: none;">
                            <i class="fas fa-cog me-2"></i>
                            <strong>Distribuição personalizada:</strong><br>
                            <div id="distributionContainer" class="mt-2">
                                <!-- Distribuição será carregada aqui -->
                            </div>
                            <div class="mt-2">
                                <strong>Total: <span id="distributionTotal" class="text-danger">0</span>/24 questões</span></strong>
                            </div>
                            <small style="color: var(--inteli-muted);">Total deve ser igual a 24 questões.</small>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary btn-sm" onclick="createSimulado()">
                        Iniciar Simulado
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para detalhes do simulado -->
    <div class="modal fade" id="simuladoDetailsModal" tabindex="-1" aria-labelledby="simuladoDetailsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="simuladoDetailsModalLabel">Detalhes do Simulado</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="simuladoDetailsModalBody">
                    <!-- Conteúdo será preenchido dinamicamente -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                    <button type="button" class="btn btn-primary btn-sm" onclick="repeatSimuladoFromDetailsModal()">
                        Repetir Configuração
                    </button>
                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="window.location.href='/test'">
                        Fazer Novo Simulado
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para resultados completos do simulado -->
    <div class="modal fade" id="simuladoResultsModal" tabindex="-1" aria-labelledby="simuladoResultsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="simuladoResultsModalLabel">Resultados Completos do Simulado</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="simuladoResultsModalBody">
                    <!-- Conteúdo será preenchido dinamicamente -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                    <button type="button" class="btn btn-primary btn-sm" onclick="repeatSimuladoFromResultsModal()">
                        Repetir Configuração
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Spinner -->
    <div id="loadingSpinner" class="position-fixed top-50 start-50 translate-middle" style="display: none; z-index: 9999;">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Carregando...</span>
        </div>
    </div>

    <!-- Footer -->
    <footer class="mt-5" style="background: var(--inteli-card); border-top: 1px solid var(--inteli-border);">
        <div class="container py-3">
            <div class="row">
                <div class="col-12 text-center">
                    <p class="mb-0 text-muted" style="font-size: 0.8rem; opacity: 0.8;">
                        Feito por <a href="https://github.com/aeternam-x" target="_blank" rel="noopener noreferrer" style="color: var(--inteli-primary); text-decoration: none; font-weight: 500;">Juan Sales</a>
                    </p>
                </div>
            </div>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        let availableExams = [];
        let selectedExams = [];

        // Load dashboard data
        document.addEventListener('DOMContentLoaded', function() {
            loadDashboardData();
        });

        async function loadDashboardData() {
            showLoading(true);
            try {
                await Promise.all([
                    loadAvailableExams(),
                    loadSimuladosHistory()
                ]);
            } catch (error) {
                console.error('Erro ao carregar dados:', error);
                showAlert('Erro ao carregar dados do dashboard', 'danger');
            } finally {
                showLoading(false);
            }
        }



        async function loadAvailableExams() {
            const response = await fetch('/api/exams/available');
            availableExams = await response.json();
            
            const examsContainer = document.getElementById('examsContainer');
            if (availableExams.length === 0) {
                examsContainer.innerHTML = `
                    <div class="col-12 text-center py-5">
                        <div class="bg-light rounded-3 p-5">
                            <i class="fas fa-exclamation-triangle fa-4x text-warning mb-4"></i>
                            <h4 class="text-muted mb-3">Nenhuma prova disponível</h4>
                            <p class="text-muted">Não foi possível carregar as provas disponíveis.</p>
                        </div>
                    </div>
                `;
                return;
            }
            
            // Ordenar exames por ano (2025, 2024, 2023, 2022)
            const sortedExams = availableExams.sort((a, b) => {
                const yearA = parseInt(a.name.match(/\d{4}/)?.[0] || '0');
                const yearB = parseInt(b.name.match(/\d{4}/)?.[0] || '0');
                return yearB - yearA;
            });

            examsContainer.innerHTML = sortedExams.map(exam => `
                <div class="col-lg-3 col-md-4 col-sm-6 mb-3">
                    <div class="exam-card p-3 h-100 d-flex flex-column justify-content-between" style="min-height: 140px;">
                        <div class="text-center mb-3">
                            <h5 class="mb-2" style="font-size: 1.1rem; font-weight: 600;">${exam.name}</h5>
                            <span class="badge" style="background-color: #3b82f6; color: white; font-size: 0.8rem; padding: 0.4rem 0.8rem; border-radius: 6px;">${exam.question_count} questões</span>
                        </div>
                        <div class="d-flex">
                            <button class="btn btn-outline-primary btn-sm w-100" onclick="showCreateSimuladoWithExam('${exam.id}')" style="font-size: 0.8rem; padding: 0.375rem 0.75rem;">
                                Criar Simulado
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        async function loadSimuladosHistory() {
            try {
                const response = await fetch('/api/simulados/history');
                const history = await response.json();
                
                const historyContainer = document.getElementById('historyContainer');
                if (history.length === 0) {
                    historyContainer.innerHTML = `
                        <div class="text-center py-5">
                            <div class="bg-light rounded-3 p-5">
                                <i class="fas fa-rocket fa-4x text-primary mb-4"></i>
                                <h4 class="text-muted mb-3">Nenhum simulado realizado ainda</h4>
                                <p class="text-muted mb-4">Comece sua jornada de preparação criando seu primeiro simulado!</p>
                                <button class="btn btn-primary btn-lg" onclick="showCreateSimulado()">
                                    <i class="fas fa-plus me-2"></i>Criar Primeiro Simulado
                                </button>
                            </div>
                        </div>
                    `;
                    return history;
                }
                
                historyContainer.innerHTML = history.map(simulado => `
                    <div class="col-lg-3 col-md-6 col-sm-12 mb-3">
                        <div class="history-item p-3 h-100" data-simulado-id="${simulado.id}" style="min-height: 140px;">
                            <div class="text-center mb-2">
                                <div class="progress-circle mx-auto mb-2" style="background-color: ${getProgressColor(simulado.percentual_acerto)}; color: white; width: 50px; height: 50px; font-size: 12px;">
                                    ${simulado.percentual_acerto}%
                                </div>
                                <h6 class="mb-1" style="font-size: 0.9rem;">
                                    Simulado #${simulado.id}
                                </h6>
                                <p class="text-muted mb-2" style="font-size: 0.8rem;">
                                    ${new Date(simulado.data_criacao).toLocaleDateString('pt-BR')}
                                </p>
                                <div class="d-flex gap-1 justify-content-center mb-3">
                                    <span class="badge" style="background-color: var(--inteli-success); color: white; font-size: 0.7rem;">
                                        ${simulado.acertos} acertos
                                    </span>
                                    <span class="badge" style="background-color: var(--inteli-danger); color: white; font-size: 0.7rem;">
                                        ${simulado.erros} erros
                                    </span>
                                    <span class="badge" style="background-color: var(--inteli-warning); color: var(--inteli-dark); font-size: 0.7rem;">
                                        ${simulado.puladas} puladas
                                    </span>
                                </div>
                            </div>
                            <div class="d-flex gap-2">
                                <button class="btn btn-outline-success btn-sm flex-fill" 
                                        onclick="showSimuladoResults(${simulado.id})" style="font-size: 0.8rem;">
                                    Ver resultados
                                </button>
                                <button class="btn btn-outline-info btn-sm flex-fill" 
                                        onclick="repeatSimulado(${simulado.id})" style="font-size: 0.8rem;">
                                    Repetir
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('');
                
                return history;
            } catch (error) {
                console.error('Erro ao carregar histórico de simulados:', error);
                return [];
            }
        }

        function getProgressColor(percentage) {
            if (percentage >= 80) return '#28A745';
            if (percentage >= 60) return '#FFC107';
            if (percentage >= 40) return '#fd7e14';
            return '#DC3545';
        }

        function showCreateSimulado() {
            selectedExams = [];
            loadExamSelection();
            new bootstrap.Modal(document.getElementById('createSimuladoModal')).show();
        }

        function showCreateSimuladoWithExam(examId) {
            // Encontrar o nome da prova pelo ID
            const exam = availableExams.find(e => e.id === examId);
            if (exam) {
                selectedExams = [exam.name];
                loadExamSelection();
                new bootstrap.Modal(document.getElementById('createSimuladoModal')).show();
            }
        }

        function showExamDetails(examId) {
            const exam = availableExams.find(e => e.id === examId);
            if (exam) {
                showAlert(`📚 ${exam.name}<br><br>📊 Total de questões: ${exam.question_count}<br>📅 Ano: ${exam.year || 'N/A'}`, 'info');
            }
        }
        


        function showSimuladoResults(simuladoId) {
            // Buscar detalhes do simulado
            fetch(`/api/simulados/history`)
                .then(response => response.json())
                .then(history => {
                    const simulado = history.find(s => s.id === simuladoId);
                    if (simulado) {
                        const details = simulado.details || {};
                        const questions = Array.isArray(details.questions) ? details.questions : [];
                        const resultsHtml = `
                            <div class="text-center mb-4">
                                <h4>📊 Resultados Completos - Simulado #${simulado.id}</h4>
                                <p class="text-muted">${new Date(simulado.data_criacao).toLocaleDateString('pt-BR')}</p>
                            </div>
                            
                            <!-- Resumo dos Resultados -->
                            <div class="bg-light p-4 rounded mb-4">
                                <h5 class="text-success mb-3">
                                    <i class="fas fa-trophy me-2"></i>Resumo dos Resultados
                                </h5>
                                <div class="row text-center mb-3">
                                    <div class="col-md-3">
                                        <div class="h4 text-success mb-1">${simulado.acertos}</div>
                                        <small class="text-muted">Acertos</small>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="h4 text-danger mb-1">${simulado.erros}</div>
                                        <small class="text-muted">Erros</small>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="h4 text-warning mb-1">${simulado.puladas}</div>
                                        <small class="text-muted">Puladas</small>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="h4 text-primary mb-1">${simulado.percentual_acerto}%</div>
                                        <small class="text-muted">Percentual</small>
                                    </div>
                                </div>
                                
                                <!-- Barra de Progresso -->
                                <div class="mb-3">
                                    <div class="progress" style="height: 20px;">
                                        <div class="progress-bar bg-success" style="width: ${(simulado.acertos / (simulado.acertos + simulado.erros + simulado.puladas)) * 100}%">
                                            ${simulado.acertos}
                                        </div>
                                        <div class="progress-bar bg-danger" style="width: ${(simulado.erros / (simulado.acertos + simulado.erros + simulado.puladas)) * 100}%">
                                            ${simulado.erros}
                                        </div>
                                        <div class="progress-bar bg-warning" style="width: ${(simulado.puladas / (simulado.acertos + simulado.erros + simulado.puladas)) * 100}%">
                                            ${simulado.puladas}
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row text-center">
                                    <div class="col-md-6">
                                        <h6><i class="fas fa-clock me-2"></i>Tempo Utilizado</h6>
                                        <p class="h5 text-info">${simulado.tempo_total || 'N/A'}</p>
                                    </div>
                                    <div class="col-md-6">
                                        <h6><i class="fas fa-calendar me-2"></i>Data</h6>
                                        <p class="h5 text-muted">${new Date(simulado.data_criacao).toLocaleDateString('pt-BR')}</p>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Gráfico de Desempenho por Bloco -->
                            <div class="row mb-4">
                                <div class="col-md-8">
                                    <div class="card">
                                        <div class="card-body">
                                            <h6 class="card-title">
                                                <i class="fas fa-chart-bar me-2"></i>Desempenho por Bloco
                                            </h6>
                                            <div class="chart-container">
                                                <canvas id="accuracy-chart-${simulado.id}"></canvas>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card">
                                        <div class="card-body">
                                            <h6 class="card-title">
                                                <i class="fas fa-info-circle me-2"></i>Informações
                                            </h6>
                                            <div class="mb-3">
                                                <h6>📚 Provas Utilizadas:</h6>
                                                <div class="mb-2">
                                                    ${(simulado.provas_selecionadas || []).length > 0 ? 
                                                        simulado.provas_selecionadas.map(prova => 
                                                            `<span class="badge me-1" style="background-color: var(--inteli-border); color: var(--inteli-text);">${prova}</span>`
                                                        ).join('') : 
                                                        '<span class="text-muted">N/A</span>'
                                                    }
                                                </div>
                                            </div>
                                            <div class="mb-3">
                                                <h6>⚙️ Tipo de Simulado:</h6>
                                                <div class="mb-2">
                                                    ${(simulado.provas_selecionadas || []).length > 0 ? 
                                                        '<span class="badge" style="background-color: var(--inteli-primary); color: white;">Personalizado</span>' : 
                                                        '<span class="badge" style="background-color: var(--inteli-border); color: var(--inteli-text);">Aleatório</span>'
                                                    }
                                                </div>
                                            </div>
                                            <div class="mb-3">
                                                <h6>🎯 Taxa de Acerto:</h6>
                                                <div class="h4 text-success">${simulado.percentual_acerto}%</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                        `;
                        
                        // Exibir o modal de resultados
                        const modal = new bootstrap.Modal(document.getElementById('simuladoResultsModal'));
                        document.getElementById('simuladoResultsModalBody').innerHTML = resultsHtml;
                        modal.show();
                        
                        // Criar o gráfico após o modal ser exibido
                        setTimeout(() => {
                            createAccuracyChart(simulado.id, simulado);
                            renderQuestionBreakdown(simulado);
                        }, 100);
                    }
                })
                .catch(error => {
                    console.error('Erro ao buscar detalhes:', error);
                    showAlert('Erro ao carregar resultados do simulado', 'danger');
                });
        }

        function createAccuracyChart(simuladoId, simulado) {
            const canvas = document.getElementById(`accuracy-chart-${simuladoId}`);
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            
            // Definir altura fixa para evitar scroll infinito
            canvas.style.height = '300px';
            canvas.style.maxHeight = '300px';
            
            // Usar dados reais do simulado se disponíveis
            let accuracies = [0, 0, 0, 0];
            
            if (simulado.details && simulado.details.accuracies && Array.isArray(simulado.details.accuracies)) {
                accuracies = simulado.details.accuracies.map(acc => Math.max(0, acc || 0));
            } else if (simulado.accuracies && Array.isArray(simulado.accuracies)) {
                // Usar dados reais de acertos por bloco
                accuracies = simulado.accuracies.map(acc => Math.max(0, acc || 0));
            } else {
                // Fallback: distribuir acertos proporcionalmente
                const totalQuestions = simulado.acertos + simulado.erros + simulado.puladas;
                const blockStructure = [8, 6, 6, 4];
                const totalCorrect = Math.max(0, simulado.acertos || 0);
                
                if (totalQuestions > 0) {
                    let remainingCorrect = totalCorrect;
                    
                    for (let i = 0; i < blockStructure.length; i++) {
                        const blockQuestions = blockStructure[i];
                        const blockRatio = blockQuestions / totalQuestions;
                        
                        let blockAccuracy = Math.round(totalCorrect * blockRatio);
                        blockAccuracy = Math.min(blockAccuracy, blockQuestions);
                        blockAccuracy = Math.max(0, blockAccuracy);
                        
                        accuracies[i] = blockAccuracy;
                    }
                    
                    // Ajustar para que a soma seja exatamente o total de acertos
                    const currentSum = accuracies.reduce((sum, acc) => sum + acc, 0);
                    const difference = totalCorrect - currentSum;
                    
                    if (difference !== 0) {
                        const lastIndex = accuracies.length - 1;
                        accuracies[lastIndex] = Math.max(0, accuracies[lastIndex] + difference);
                    }
                }
            }
            
            // Validação final: garantir que não há valores negativos
            const finalAccuracies = accuracies.map(acc => Math.max(0, acc));
            
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Bloco 1', 'Bloco 2', 'Bloco 3', 'Bloco 4'],
                    datasets: [{
                        label: 'Questões Acertadas',
                        data: finalAccuracies,
                        backgroundColor: 'rgba(40, 167, 69, 0.7)',
                        borderColor: 'rgba(40, 167, 69, 1)',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    height: 300,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 8,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `Acertos: ${context.parsed.y}`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function renderQuestionBreakdown(simulado) {
            // Render somente por blocos com expansão; remove listagem sem blocos
            if (!simulado.details || !simulado.details.questions) return;
            const questions = simulado.details.questions;
            const body = document.getElementById('simuladoResultsModalBody');
            if (!body) return;

            const card = document.createElement('div');
            card.className = 'card';
            card.innerHTML = `<div class=\"card-body\"><h5 class=\"mb-3\"><i class=\"fas fa-list-check me-2\"></i>Folha de prova corrigida</h5><div id=\"result-blocks\"></div></div>`;
            body.appendChild(card);

            const blocksRoot = card.querySelector('#result-blocks');
            const byBlock = {1:[],2:[],3:[],4:[]};
            questions.forEach(q=>{ const b=(q.bloco||1); if(byBlock[b]) byBlock[b].push(q); });

            for (let bloco=1; bloco<=4; bloco++) {
                const qList = byBlock[bloco];
                if (!qList || qList.length===0) continue;
                const section = document.createElement('div');
                section.className = 'mb-3';
                section.style.background = 'var(--inteli-card)';
                section.style.border = '1px solid var(--inteli-border)';
                section.style.borderRadius = '8px';
                section.innerHTML = `
                    <div class=\"d-flex justify-content-between align-items-center p-3\" data-bs-toggle=\"collapse\" data-bs-target=\"#bloco-${bloco}-${simulado.id}\" style=\"cursor:pointer;\">
                        <div class=\"h5 mb-0\">Bloco ${bloco}</div>
                        <i class=\"fas fa-chevron-down\"></i>
                    </div>
                    <div id=\"bloco-${bloco}-${simulado.id}\" class=\"collapse show\">
                        <div class=\"p-3 pt-0\"></div>
                    </div>
                `;
                blocksRoot.appendChild(section);
                const inner = section.querySelector('.p-3.pt-0');

                qList.forEach((q) => {
                    const qId = q.id;
                    const row = document.createElement('div');
                    row.className = 'mb-2 border rounded';
                    row.style.borderColor = 'var(--inteli-border)';
                    row.innerHTML = `
                        <div class=\"d-flex justify-content-between align-items-center p-2\" data-bs-toggle=\"collapse\" data-bs-target=\"#q-${qId}-${simulado.id}\" style=\"cursor:pointer;\">
                            <div class=\"fw-semibold\">Questão ${q.numero || ''}</div>
                            <div>
                                <span class=\"badge ${q.correta ? 'bg-success' : (q.pulada ? 'bg-warning text-dark' : 'bg-danger')}\">${q.correta ? 'Correta' : (q.pulada ? 'Pulada' : 'Errada')}</span>
                                <span class=\"ms-2 text-muted\">Sua: ${q.resposta ? q.resposta.toUpperCase() : '-'} </span>
                                <span class=\"ms-2 text-muted\">Gabarito: ${q.gabarito ? q.gabarito.toUpperCase() : '-'} </span>
                            </div>
                        </div>
                        <div id=\"q-${qId}-${simulado.id}\" class=\"collapse\">
                            <div class=\"p-3\">
                                <div class=\"mb-2\" id=\"qimg-${qId}-${simulado.id}\"></div>
                                <div id=\"qalts-${qId}-${simulado.id}\"></div>
                            </div>
                        </div>
                    `;
                    inner.appendChild(row);
                    loadQuestionDetails(qId, `qimg-${qId}-${simulado.id}`, `qalts-${qId}-${simulado.id}`, q.resposta, q.gabarito);
                });
            }
        }

        async function loadQuestionDetails(questionId, imgContainerId, altsContainerId, userAnswer, correctAnswer) {
            try {
                const res = await fetch(`/api/simulados/question/${questionId}`);
                if (!res.ok) return;
                const data = await res.json();

                const imgC = document.getElementById(imgContainerId);
                if (imgC && data.imagens && data.imagens !== '[]') {
                    try {
                        const imgs = JSON.parse(data.imagens);
                        const gallery = document.createElement('div');
                        gallery.className = 'image-gallery';
                        imgs.forEach(p => {
                            const src = (typeof p === 'string') ? p.replace(/\\\\/g,'/') : (p.path||p.url||'');
                            if (!src) return;
                            const img = document.createElement('img');
                            img.src = src.startsWith('/') ? src : `/${src}`;
                            img.className = 'question-image';
                            img.loading = 'lazy';
                            gallery.appendChild(img);
                        });
                        imgC.appendChild(gallery);
                    } catch(e) { }
                }

                const altsC = document.getElementById(altsContainerId);
                if (!altsC) return;
                const letters = ['a','b','c','d','e'];
                const list = document.createElement('div');
                letters.forEach(letter => {
                    const content = data[letter];
                    const wrap = document.createElement('div');
                    wrap.className = 'd-flex align-items-start gap-2 mb-2';
                    const isCorrect = (letter === (correctAnswer||'').toLowerCase());
                    const isSelected = (letter === (userAnswer||'').toLowerCase());
                    const badge = document.createElement('span');
                    badge.className = 'badge ' + (isCorrect ? 'bg-success' : (isSelected ? 'bg-secondary' : 'bg-dark'));
                    badge.textContent = letter.toUpperCase();
                    wrap.appendChild(badge);

                    if (typeof content === 'string' && (content.endsWith('.webp') || content.includes('questions_imgs'))) {
                        const img = document.createElement('img');
                        const src = content.replace(/\\\\/g,'/');
                        img.src = src.startsWith('/') ? src : `/${src}`;
                        img.className = 'question-image';
                        wrap.appendChild(img);
                    } else {
                        const span = document.createElement('span');
                        span.className = 'mathjax-content';
                        span.innerHTML = content || '';
                        wrap.appendChild(span);
                    }

                    if (isCorrect) {
                        const t = document.createElement('span');
                        t.className = 'ms-2 text-success';
                        t.textContent = 'Alternativa correta';
                        wrap.appendChild(t);
                    }
                    if (isSelected && !isCorrect) {
                        const t = document.createElement('span');
                        t.className = 'ms-2 text-warning';
                        t.textContent = 'Sua escolha';
                        wrap.appendChild(t);
                    }

                    list.appendChild(wrap);
                });
                altsC.appendChild(list);

                // Render MathJax para alternativas
                if (window.MathJax && window.MathJax.typesetPromise) {
                    try { await MathJax.typesetPromise([altsC]); } catch(e) {}
                }
            } catch (e) { }
        }

        function loadExamSelection() {
            const container = document.getElementById('examSelectionContainer');
            container.innerHTML = availableExams.map(exam => `
                <div class="col-md-6 mb-3">
                    <div class="exam-card p-3 ${selectedExams.includes(exam.name) ? 'selected' : ''}" 
                         onclick="toggleExamSelection('${exam.name}')">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" 
                                   id="exam_${exam.name.replace(/\s+/g, '_')}" 
                                   ${selectedExams.includes(exam.name) ? 'checked' : ''}>
                            <label class="form-check-label" for="exam_${exam.name.replace(/\s+/g, '_')}">
                                <strong>${exam.name}</strong><br>
                                <small class="text-muted">${exam.question_count} questões</small>
                            </label>
                        </div>
                    </div>
                </div>
            `).join('');
            
            // Carregar distribuição personalizada
            loadDistributionConfig();
        }
        
        function loadDistributionConfig() {
            const container = document.getElementById('distributionContainer');
            if (selectedExams.length === 0) {
                container.innerHTML = '<p class="text-muted">Selecione provas para configurar a distribuição</p>';
                return;
            }
            
            container.innerHTML = selectedExams.map((exam, index) => `
                <div class="row align-items-center mb-2">
                    <div class="col-6">
                        <label class="form-label mb-0">${exam}:</label>
                    </div>
                    <div class="col-6">
                        <input type="number" class="form-control form-control-sm" 
                               id="dist_${exam.replace(/\s+/g, '_')}" 
                               data-exam-name="${exam}"
                               min="0" max="24" value="0" 
                               onchange="updateDistributionTotal()"
                               oninput="updateDistributionTotal()"
                               placeholder="0">
                    </div>
                </div>
            `).join('');
            
            updateDistributionTotal();
        }
        
        function updateDistributionTotal() {
            const total = selectedExams.reduce((sum, exam) => {
                const input = document.getElementById(`dist_${exam.replace(/\s+/g, '_')}`);
                if (input) {
                    const value = parseInt(input.value) || 0;
                    return sum + value;
                }
                return sum;
            }, 0);
            
            const totalElement = document.getElementById('distributionTotal');
            if (totalElement) {
                totalElement.textContent = total;
                totalElement.className = total === 24 ? 'text-success' : 'text-danger';
            }
        }
        
        // Event listeners para mudança de modo
        document.addEventListener('DOMContentLoaded', function() {
            const modeInputs = document.querySelectorAll('input[name="simuladoMode"]');
            modeInputs.forEach(input => {
                input.addEventListener('change', function() {
                    const isRandom = this.value === 'random';
                    document.getElementById('randomConfig').style.display = isRandom ? 'block' : 'none';
                    document.getElementById('customConfig').style.display = isRandom ? 'none' : 'block';
                });
            });
        });

        function toggleExamSelection(examId) {
            const index = selectedExams.indexOf(examId);
            if (index > -1) {
                selectedExams.splice(index, 1);
            } else {
                selectedExams.push(examId);
            }
            loadExamSelection();
        }

        async function createSimulado() {
            if (selectedExams.length === 0) {
                showAlert('Selecione pelo menos uma prova', 'warning');
                return;
            }

            // Verificar modo selecionado
            const mode = document.querySelector('input[name="simuladoMode"]:checked').value;
            let examDistribution = null;
            
            if (mode === 'custom') {
                // Coletar distribuição personalizada
                examDistribution = {};
                let total = 0;
                
                selectedExams.forEach(exam => {
                    const input = document.getElementById(`dist_${exam.replace(/\s+/g, '_')}`);
                    if (input) {
                        const value = parseInt(input.value) || 0;
                        examDistribution[exam] = value;
                        total += value;
                    }
                });
                
                if (total !== 24) {
                    showAlert(`Total deve ser 24 questões. Atual: ${total}`, 'warning');
                    return;
                }
                
                // Verificar se pelo menos uma prova tem questões
                const hasQuestions = Object.values(examDistribution).some(val => val > 0);
                if (!hasQuestions) {
                    showAlert('Selecione pelo menos uma questão para cada prova', 'warning');
                    return;
                }
                
                // Verificar se não há valores negativos
                const hasNegativeValues = Object.values(examDistribution).some(val => val < 0);
                if (hasNegativeValues) {
                    showAlert('Não é permitido valores negativos', 'warning');
                    return;
                }
            }

            showLoading(true);
            try {
                console.log('Enviando requisição para criar simulado...');
                console.log('Dados:', {
                    selected_exams: selectedExams,
                    num_questions: 24,
                    exam_distribution: examDistribution
                });

                const response = await fetch('/api/simulados/create', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    credentials: 'same-origin',
                    body: JSON.stringify({
                        selected_exams: selectedExams,
                        num_questions: 24,
                        exam_distribution: examDistribution
                    })
                });

                console.log('Resposta recebida:', response.status, response.statusText);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Erro na resposta:', errorText);
                    throw new Error(`Erro HTTP ${response.status}: ${errorText}`);
                }

                const result = await response.json();
                console.log('Resultado:', result);
                
                if (result.success) {
                    // Fechar modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('createSimuladoModal'));
                    if (modal) {
                        modal.hide();
                    }
                    
                    // Redirecionar para o simulado
                    window.location.href = '/test';
                } else {
                    showAlert('Erro ao criar simulado: ' + (result.error || 'Erro desconhecido'), 'danger');
                }
            } catch (error) {
                console.error('Erro ao criar simulado:', error);
                if (error.name === 'TypeError' && error.message.includes('Failed to fetch')) {
                    showAlert('Erro de conexão: Verifique se o servidor está rodando e tente novamente', 'danger');
                } else {
                    showAlert('Erro ao criar simulado: ' + error.message, 'danger');
                }
            } finally {
                showLoading(false);
            }
        }

        function showLoading(show) {
            document.getElementById('loadingSpinner').style.display = show ? 'block' : 'none';
        }

        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
            alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(alertDiv);
            
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 5000);
        }

        // Função para verificar se há resultados na URL e exibir na seção de resultados
        function checkForResults() {
            const urlParams = new URLSearchParams(window.location.search);
            const results = urlParams.get('results');
            
            if (results) {
                console.log('Resultados encontrados na URL:', results);
                try {
                    const resultsData = JSON.parse(decodeURIComponent(results));
                    console.log('Resultados decodificados:', resultsData);
                    
                    // Limpar a URL imediatamente para evitar exibição automática
                    window.history.replaceState({}, document.title, window.location.pathname);
                    
                    // Não exibir resultados automaticamente - apenas armazenar para uso posterior
                    // Os resultados serão exibidos apenas quando o usuário clicar em "Ver resultados completos"
                    console.log('Resultados armazenados para exibição sob demanda');
                } catch (error) {
                    console.error('Erro ao processar resultados:', error);
                    showAlert('Erro ao processar resultados da prova', 'danger');
                }
            }
        }

        // Função para exibir resultados na seção de resultados
        function showResultsInDetails(results) {
            console.log('Exibindo resultados:', results);
            
            // Função para tentar exibir os resultados
            const tryShowResults = (attempts = 0) => {
                const historyContainer = document.getElementById('historyContainer');
                if (historyContainer) {
                    // Procurar pelo simulado correspondente e mostrar os detalhes
                    const simuladoElement = historyContainer.querySelector(`[data-simulado-id="${results.simulado_id}"]`);
                    if (simuladoElement) {
                        // Simular clique no botão "Ver resultados completos" para mostrar os resultados
                        const resultsBtn = simuladoElement.querySelector('.btn-results');
                        if (resultsBtn) {
                            // Primeiro, buscar os detalhes do simulado
                            fetch(`/api/simulados/history`)
                                .then(response => response.json())
                                .then(history => {
                                    const simulado = history.find(s => s.id === results.simulado_id);
                                    if (simulado) {
                                        // Criar HTML com os resultados incluídos
                                        const resultsHtml = `
                                            <div class="text-center mb-4">
                                                <h4>📊 Resultados Completos - Simulado #${simulado.id}</h4>
                                                <p class="text-muted">${new Date(simulado.data_criacao || simulado.data).toLocaleDateString('pt-BR')}</p>
                                            </div>
                                            
                                            <!-- Seção de Resultados do Simulado -->
                                            <div class="bg-light p-4 rounded mb-4">
                                                <h5 class="text-success mb-3">
                                                    <i class="fas fa-trophy me-2"></i>Resultados do Simulado
                                                </h5>
                                                <div class="row text-center mb-3">
                                                    <div class="col-md-3">
                                                        <div class="h4 text-success mb-1">${results.correct_answers}</div>
                                                        <small class="text-muted">Acertos</small>
                                                    </div>
                                                    <div class="col-md-3">
                                                        <div class="h4 text-danger mb-1">${results.incorrect_answers}</div>
                                                        <small class="text-muted">Erros</small>
                                                    </div>
                                                    <div class="col-md-3">
                                                        <div class="h4 text-warning mb-1">${results.skipped_questions}</div>
                                                        <small class="text-muted">Puladas</small>
                                                    </div>
                                                    <div class="col-md-3">
                                                        <div class="h4 text-primary mb-1">${results.percentage}%</div>
                                                        <small class="text-muted">Percentual</small>
                                                    </div>
                                                </div>
                                                
                                                <!-- Barra de Progresso -->
                                                <div class="mb-3">
                                                    <div class="progress" style="height: 20px;">
                                                        <div class="progress-bar bg-success" style="width: ${(results.correct_answers / results.total_questions) * 100}%">
                                                            ${results.correct_answers}
                                                        </div>
                                                        <div class="progress-bar bg-danger" style="width: ${(results.incorrect_answers / results.total_questions) * 100}%">
                                                            ${results.incorrect_answers}
                                                        </div>
                                                        <div class="progress-bar bg-warning" style="width: ${(results.skipped_questions / results.total_questions) * 100}%">
                                                            ${results.skipped_questions}
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                <div class="row text-center">
                                                    <div class="col-md-6">
                                                        <h6><i class="fas fa-clock me-2"></i>Tempo Utilizado</h6>
                                                        <p class="h5 text-info">${results.time_used}</p>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <h6><i class="fas fa-calendar me-2"></i>Data</h6>
                                                        <p class="h5 text-muted">${new Date().toLocaleDateString('pt-BR')}</p>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <!-- Gráfico de Desempenho por Bloco -->
                                            <div class="row mb-4">
                                                <div class="col-md-8">
                                                    <div class="card">
                                                        <div class="card-body">
                                                            <h6 class="card-title">
                                                                <i class="fas fa-chart-bar me-2"></i>Desempenho por Bloco
                                                            </h6>
                                                            <div class="chart-container">
                                                                <canvas id="accuracy-chart-results"></canvas>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="col-md-4">
                                                    <div class="card">
                                                        <div class="card-body">
                                                            <h6 class="card-title">
                                                                <i class="fas fa-info-circle me-2"></i>Informações
                                                            </h6>
                                                            <div class="mb-3">
                                                                <h6>📚 Provas Utilizadas:</h6>
                                                                <div class="mb-2">
                                                                    ${(simulado.provas_selecionadas || []).map(prova => 
                                                                        `<span class="badge me-1" style="background-color: var(--inteli-border); color: var(--inteli-text);">${prova}</span>`
                                                                    ).join('')}
                                                                </div>
                                                            </div>
                                                            <div class="mb-3">
                                                                <h6>🎯 Taxa de Acerto:</h6>
                                                                <div class="h4 text-success">${results.percentage}%</div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                        `;
                                        
                                        // Exibir os resultados no modal de resultados
                                        const modal = new bootstrap.Modal(document.getElementById('simuladoResultsModal'));
                                        document.getElementById('simuladoResultsModalBody').innerHTML = resultsHtml;
                                        modal.show();
                                        
                                        // Criar o gráfico após o modal ser exibido
                                        setTimeout(() => {
                                            createResultsChart(results);
                                        }, 100);
                                    } else {
                                        // Se o simulado não foi encontrado, tentar novamente
                                        if (attempts < 5) {
                                            setTimeout(() => tryShowResults(attempts + 1), 2000);
                                        } else {
                                            console.error('Simulado não encontrado após várias tentativas');
                                            showAlert('Erro: Simulado não encontrado. Tente recarregar a página.', 'warning');
                                        }
                                    }
                                })
                                .catch(error => {
                                    console.error('Erro ao buscar detalhes:', error);
                                    if (attempts < 5) {
                                        setTimeout(() => tryShowResults(attempts + 1), 2000);
                                    } else {
                                        showAlert('Erro ao carregar detalhes do simulado', 'danger');
                                    }
                                });
                        } else {
                            // Se o botão não foi encontrado, tentar novamente
                            if (attempts < 5) {
                                setTimeout(() => tryShowResults(attempts + 1), 2000);
                            }
                        }
                    } else {
                        // Se o simulado não foi encontrado no histórico, recarregar o histórico e tentar novamente
                        if (attempts < 5) {
                            console.log('Simulado não encontrado no histórico, tentativa', attempts + 1, 'de 5');
                            if (attempts >= 2) {
                                // Após algumas tentativas, recarregar o histórico
                                console.log('Recarregando histórico...');
                                loadSimuladosHistory().then(() => {
                                    setTimeout(() => tryShowResults(attempts + 1), 2000);
                                });
                            } else {
                                setTimeout(() => tryShowResults(attempts + 1), 2000);
                            }
                        } else {
                            console.error('Simulado não encontrado após várias tentativas');
                            showAlert('Erro: Simulado não encontrado. Tente recarregar a página.', 'warning');
                        }
                    }
                } else {
                    // Se o container não foi encontrado, tentar novamente
                    if (attempts < 5) {
                        setTimeout(() => tryShowResults(attempts + 1), 2000);
                    }
                }
            };
            
            // Iniciar tentativas após um pequeno delay
            setTimeout(() => tryShowResults(), 1000);
        }

        function createResultsChart(results) {
            const canvas = document.getElementById('accuracy-chart-results');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            
            // Definir altura fixa para evitar scroll infinito
            canvas.style.height = '300px';
            canvas.style.maxHeight = '300px';
            
            // Dados para o gráfico baseado nos resultados
            const totalQuestions = results.total_questions;
            const blockStructure = [8, 6, 6, 4]; // Estrutura padrão dos blocos
            
            // Validar dados de entrada
            if (!results.correct_answers || results.correct_answers < 0) {
                console.warn('Dados de acertos inválidos:', results.correct_answers);
                results.correct_answers = 0;
            }
            
            // Calcular acertos por bloco de forma mais simples e robusta
            const accuracies = [];
            const totalCorrect = Math.max(0, results.correct_answers);
            
            // Distribuir acertos de forma proporcional pelos blocos
            for (let i = 0; i < blockStructure.length; i++) {
                const blockQuestions = blockStructure[i];
                const blockRatio = blockQuestions / totalQuestions;
                
                // Calcular acertos para este bloco baseado na proporção
                let blockAccuracy = Math.round(totalCorrect * blockRatio);
                
                // Garantir que não exceda o número de questões do bloco
                blockAccuracy = Math.min(blockAccuracy, blockQuestions);
                
                // Garantir que não seja negativo
                blockAccuracy = Math.max(0, blockAccuracy);
                
                accuracies.push(blockAccuracy);
            }
            
            // Ajustar para que a soma seja exatamente o total de acertos
            const currentSum = accuracies.reduce((sum, acc) => sum + acc, 0);
            const difference = totalCorrect - currentSum;
            
            if (difference !== 0) {
                // Ajustar o último bloco para compensar a diferença
                const lastIndex = accuracies.length - 1;
                accuracies[lastIndex] = Math.max(0, accuracies[lastIndex] + difference);
            }
            
            // Validação final: garantir que não há valores negativos
            const finalAccuracies = accuracies.map(acc => Math.max(0, acc));
            
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Bloco 1', 'Bloco 2', 'Bloco 3', 'Bloco 4'],
                    datasets: [{
                        label: 'Questões Acertadas',
                        data: finalAccuracies,
                        backgroundColor: 'rgba(40, 167, 69, 0.7)',
                        borderColor: 'rgba(40, 167, 69, 1)',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    height: 300,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: Math.max(...blockStructure),
                            ticks: {
                                stepSize: 1
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `Acertos: ${context.parsed.y}`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function repeatSimulado(simuladoId) {
            // Buscar detalhes do simulado para repetir a configuração
            fetch(`/api/simulados/history`)
                .then(response => response.json())
                .then(history => {
                    const simulado = history.find(s => s.id === simuladoId);
                    if (simulado) {
                        // Configurar o modal com as mesmas provas
                        selectedExams = simulado.provas_selecionadas || [];
                        
                        // Carregar seleção de provas
                        loadExamSelection();
                        
                        // Mostrar modal de criação
                        const modal = new bootstrap.Modal(document.getElementById('createSimuladoModal'));
                        modal.show();
                    }
                })
                .catch(error => {
                    console.error('Erro ao buscar simulado:', error);
                    showAlert('Erro ao carregar configuração do simulado', 'danger');
                });
        }

        function repeatSimuladoFromDetailsModal() {
            // Fechar modal de detalhes
            const detailsModal = bootstrap.Modal.getInstance(document.getElementById('simuladoDetailsModal'));
            if (detailsModal) {
                detailsModal.hide();
            }
            
            // Buscar o simulado atual da sessão ou usar o último do histórico
            fetch(`/api/simulados/history`)
                .then(response => response.json())
                .then(history => {
                    if (history.length > 0) {
                        const lastSimulado = history[0]; // Último simulado
                        repeatSimulado(lastSimulado.id);
                    } else {
                        showAlert('Nenhum simulado encontrado para repetir', 'warning');
                    }
                })
                .catch(error => {
                    console.error('Erro ao buscar histórico:', error);
                    showAlert('Erro ao carregar configuração do simulado', 'danger');
                });
        }

        function repeatSimuladoFromResultsModal() {
            // Fechar modal de resultados
            const resultsModal = bootstrap.Modal.getInstance(document.getElementById('simuladoResultsModal'));
            if (resultsModal) {
                resultsModal.hide();
            }
            
            // Buscar o simulado atual da sessão ou usar o último do histórico
            fetch(`/api/simulados/history`)
                .then(response => response.json())
                .then(history => {
                    if (history.length > 0) {
                        const lastSimulado = history[0]; // Último simulado
                        repeatSimulado(lastSimulado.id);
                    } else {
                        showAlert('Nenhum simulado encontrado para repetir', 'warning');
                    }
                })
                .catch(error => {
                    console.error('Erro ao buscar histórico:', error);
                    showAlert('Erro ao carregar configuração do simulado', 'danger');
                });
        }

        // Verificar resultados ao carregar a página
        document.addEventListener('DOMContentLoaded', function() {
            loadDashboardData();
        });
        
        // Verificar resultados após o dashboard ser carregado
        async function loadDashboardData() {
            showLoading(true);
            try {
                await Promise.all([
                    loadAvailableExams(),
                    loadSimuladosHistory()
                ]);
                
                // Verificar resultados após carregar o histórico
                setTimeout(() => {
                    checkForResults();
                }, 500);
            } catch (error) {
                console.error('Erro ao carregar dados:', error);
                showAlert('Erro ao carregar dados do dashboard', 'danger');
            } finally {
                showLoading(false);
            }
        }
    </script>
</body>
</html>
